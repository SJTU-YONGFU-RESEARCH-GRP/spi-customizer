// =============================================
// SPI Master Testbench - Auto-generated by SPI Customizer
// =============================================

`timescale 1ns / 1ps

module spi_master_tb;

    // Parameters
    parameter MODE = 3;
    parameter DATA_WIDTH = 8;
    parameter NUM_SLAVES = 8;
    parameter SLAVE_ACTIVE_LOW = 1;
    parameter MSB_FIRST = 1;
    parameter FIFO_DEPTH = 16;
    parameter CLOCK_DIVIDER = 2;
    parameter DEFAULT_DATA_ENABLED = 0;
    parameter DEFAULT_DATA_PATTERN = "a5a5";
    parameter DEFAULT_DATA_VALUE = 16'hA5A5;

    // Signals
    reg clk;
    reg rst_n;
    reg start_tx;
    reg start_rx;
    reg [DATA_WIDTH-1:0] tx_data;
    wire [DATA_WIDTH-1:0] rx_data;
    wire busy;
    wire sclk;
    wire mosi;
    reg miso;
    wire [NUM_SLAVES-1:0] ss_n;
    wire irq;

    // DUT instantiation
    spi_master #(
        .MODE(MODE),
        .DATA_WIDTH(DATA_WIDTH),
        .NUM_SLAVES(NUM_SLAVES),
        .SLAVE_ACTIVE_LOW(SLAVE_ACTIVE_LOW),
        .MSB_FIRST(MSB_FIRST),
        .FIFO_DEPTH(FIFO_DEPTH),
        .CLOCK_DIVIDER(CLOCK_DIVIDER),
        .DEFAULT_DATA_ENABLED(DEFAULT_DATA_ENABLED),
        .DEFAULT_DATA_PATTERN(DEFAULT_DATA_PATTERN),
        .DEFAULT_DATA_VALUE(DEFAULT_DATA_VALUE)
    ) dut (
        .clk(clk),
        .rst_n(rst_n),
        .start_tx(start_tx),
        .start_rx(start_rx),
        .tx_data(tx_data),
        .rx_data(rx_data),
        .busy(busy),
        .sclk(sclk),
        .mosi(mosi),
        .miso(miso),
        .ss_n(ss_n),
        .irq(irq)
    );

    // Clock generation
    initial begin
        clk = 0;
        forever #10 clk = ~clk;  // 50MHz clock
    end

    // Test sequence for master mode
    initial begin
        // Initialize
        rst_n = 0;
        start_tx = 0;
        start_rx = 0;
        tx_data = 0;
        miso = 0;

        #100;
        rst_n = 1;
        #200;  // Allow system to stabilize

        $display("=== SPI Master RTL Testbench Starting ===");
        $display("Configuration: Mode %d, %d-bit data, %d slaves", MODE, DATA_WIDTH, NUM_SLAVES);

        // Test core SPI functionality (optimized for speed)
        $display("--- Testing Core SPI Functionality ---");

        // Test 1: Basic data transmission
        
        tx_data = 8'hA5;
        $display("TX Data: 0x%h", tx_data);
        start_tx = 1;
        #50;
        start_tx = 0;

        wait (!busy);
        $display("✓ Transmission complete");

        // Brief delay between transactions
        #200;
        

        // Test 2: Different data pattern (test MSB/LSB order)
        tx_data = 8'h55;
        $display("TX Data: 0x%h", tx_data);
        start_tx = 1;
        #50;
        start_tx = 0;

        wait (!busy);
        $display("✓ Second transmission complete");

        // Test reception (simplified for speed)
        $display("--- Testing Reception ---");

        
        // Prepare to receive data from slave 0
        start_rx = 1;
        #50;
        start_rx = 0;

        // Simulate slave providing response data
        #200;
        miso = 1'b1;  // Data bit based on CPHA

        wait (!busy);
        $display("✓ Reception complete");
        

        // Test 3: Quick burst transmission (simplified)
        $display("--- Testing Burst Transmission ---");
        tx_data = 8'hF0;
        $display("Burst TX: 0x%h", tx_data);
        start_tx = 1;
        #30;
        start_tx = 0;

        wait (!busy);
        $display("✓ Burst transmission complete");

        // Test 4: Quick configuration test
        $display("--- Testing Configuration ---");
        tx_data = 8'hAB;
        $display("Config TX: 0x%h", tx_data);
        start_tx = 1;
        #30;
        start_tx = 0;

        wait (!busy);
        $display("✓ Configuration test complete");

        $display("=== All Master Tests Completed Successfully ===");
        $finish;
    end

    // VCD dumping
    initial begin
        $dumpfile("spi_waveform.vcd");
        $dumpvars(0, spi_master_tb);
    end

endmodule